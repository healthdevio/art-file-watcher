# Pipeline de CI/CD otimizado - Compat√≠vel com GitLab 10.7.3-ee
# Vari√°veis de ambiente configuradas no reposit√≥rio
# - MINIO_ACCESS_KEY
# - MINIO_SECRET_KEY
# - REGISTRY_PASSWORD
#
# Observa√ß√£o:
# Para as vari√°veis de ambiente ficarem dispon√≠veis no pipeline, √© necess√°rio que a branch esteja protegida

stages:
  - setup
  - lint
  - test
  - build
  - deploy

# Vari√°veis globais
variables:
  NPM_CONFIG_CACHE: '$CI_PROJECT_DIR/.npm'
  NPM_CONFIG_PREFER_OFFLINE: 'true'
  NPM_CONFIG_AUDIT: 'false'
  NPM_CONFIG_FUND: 'false'
  PROJECT_NAME: 'art-file-watcher'

  REGISTRY_HOST: 'registry.mutua.com.br'
  REGISTRY_USER: 'inova_mutua'

  MINIO_PORT: 9090
  MINIO_ENDPOINT: 'dckr03.mutua.com.br'
  MINIO_REGION: 'us-east-1'
  MINIO_BUCKET: 'mutua360-hmg'
  MINIO_USE_SSL: 'false'

# ===========================================
# STAGE: SETUP
# ===========================================

# Job dedicado para preparar cache de depend√™ncias
prepare_cache:
  stage: setup
  image: node:lts-alpine
  before_script:
    - echo "Preparando cache de depend√™ncias..."
    - node --version
    - npm --version
  script:
    - npm ci --cache .npm --prefer-offline
    - echo "Cache de depend√™ncias preparado com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull-push

# Template para jobs que precisam do MinIO
.minio_setup: &minio_setup
  before_script:
    - echo "Configurando Ambiente de Deploy"
    - docker info
    - echo "Configurando MinIO client (http://$MINIO_ENDPOINT:$MINIO_PORT)"
    - apk add --no-cache curl
    - curl -o /usr/local/bin/mc https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod +x /usr/local/bin/mc
    - mc alias set minio http://$MINIO_ENDPOINT:$MINIO_PORT $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

# ===========================================
# STAGE: LINT
# ===========================================
lint:
  stage: lint
  image: node:lts-alpine
  script:
    - echo "Instalando depend√™ncias do cache"
    - npm ci --cache .npm --prefer-offline
    - echo "üöì Executando an√°lise de c√≥digo"
    - npm run ci:lint
    - echo "Lint executado com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull
  allow_failure: false

# test:e2e:
#   stage: test
#   image: node:lts-alpine
#   dependencies:
#     - prepare
#   before_script:
#     - echo "Executando testes end-to-end..."
#   script:
#     - npm run test:e2e
#     - echo "Testes e2e executados com sucesso!"
#   allow_failure: false

# ===========================================
# STAGE: BUILD
# ===========================================
build:
  stage: build
  image: node:lts-alpine
  dependencies:
    - prepare_cache
  before_script:
    - echo "Instalando depend√™ncias do cache..."
    - npm ci --cache .npm --prefer-offline
    # - echo "Configurando arquivo de ambiente para build..."
    # - cp .env.homologation .env
  script:
    - npm run build
    - echo "Verificando arquivos gerados..."
    - ls -la dist/
    - echo "Build executado com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull
  allow_failure: false

# ===========================================
# STAGE: DEPLOY
# ===========================================
deploy:staging:
  stage: deploy
  environment:
    name: staging
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'unix:///runner/services/docker/docker.sock'
    DOCKER_TLS_CERTDIR: '/certs'
    ENVIRONMENT: 'homologation'
    TAG: 'latest'
    WEBHOOK_URL: 'https://portainer-hmg.mutua.com.br/api/webhooks/9b32e5fa-bb5c-4263-94b8-d40be1f5967c'
    IMAGE_NAME: 'registry.mutua.com.br/mutua360/$PROJECT_NAME'

  <<: *minio_setup
  script:
    - export PROJECT_NAME="${PROJECT_NAME}"
    - echo "PROJECT_NAME ${PROJECT_NAME}, TAG ${TAG}, IMAGE_NAME ${IMAGE_NAME} - $IMAGE_NAME:$TAG"
    - echo "üöÄ Iniciando deploy para $PROJECT_NAME $ENVIRONMENT - $REGISTRY_USER $REGISTRY_HOST"
    - docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
    - echo "üê≥ Construindo imagem Docker ($IMAGE_NAME:$TAG)"
    - docker build --platform linux/amd64 -t "$IMAGE_NAME:$TAG" .
    - echo "üì§ Enviando imagem para o reposit√≥rio..."
    - docker push "$IMAGE_NAME:$TAG"
    - echo "üîî Disparando webhook de atualiza√ß√£o..."
    - curl -X POST "$WEBHOOK_URL"
    - echo "‚úÖ Deploy para ${ENVIRONMENT} conclu√≠do com sucesso."
  only:
    - develop
  allow_failure: false

deploy:production:
  stage: deploy
  environment:
    name: production
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'unix:///runner/services/docker/docker.sock'
    DOCKER_TLS_CERTDIR: '/certs'
    ENVIRONMENT: 'production'
    TAG: 'stable'
    WEBHOOK_URL: 'https://portainer.mutua.com.br/api/webhooks/b78143fd-825f-4995-9a33-e103bbc726c4'
    IMAGE_NAME: 'registry.mutua.com.br/mutua360/$PROJECT_NAME'

  <<: *minio_setup
  script:
    - export PROJECT_NAME="${PROJECT_NAME}"
    - echo "PROJECT_NAME ${PROJECT_NAME}, TAG ${TAG}, IMAGE_NAME ${IMAGE_NAME} - $IMAGE_NAME:$TAG"
    - echo "üöÄ Iniciando deploy para $PROJECT_NAME $ENVIRONMENT - $REGISTRY_USER $REGISTRY_HOST"
    - docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
    - echo "üê≥ Construindo imagem Docker ($IMAGE_NAME:$TAG)"
    - docker build --platform linux/amd64 -t "$IMAGE_NAME:$TAG" .
    - echo "üì§ Enviando imagem para o reposit√≥rio..."
    - docker push "$IMAGE_NAME:$TAG"
    - echo "üîî Disparando webhook de atualiza√ß√£o..."
    - curl -X POST "$WEBHOOK_URL"
    - echo "‚úÖ Deploy para ${ENVIRONMENT} conclu√≠do com sucesso."

  after_script:
    - echo "‚úÖ Deploy para ${ENVIRONMENT} conclu√≠do com sucesso."
  only:
    - main
  allow_failure: false
