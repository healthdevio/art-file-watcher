# Pipeline de CI/CD otimizado - CompatÃ­vel com GitLab 10.7.3-ee
# VariÃ¡veis de ambiente configuradas no repositÃ³rio
# - MINIO_ACCESS_KEY
# - MINIO_SECRET_KEY
# - REGISTRY_PASSWORD
#
# ObservaÃ§Ã£o:
# Para as variÃ¡veis de ambiente ficarem disponÃ­veis no pipeline, Ã© necessÃ¡rio que a branch esteja protegida

stages:
  - setup
  - lint
  - build
  - deploy

# VariÃ¡veis globais
variables:
  NPM_CONFIG_CACHE: '$CI_PROJECT_DIR/.npm'
  NPM_CONFIG_PREFER_OFFLINE: 'true'
  NPM_CONFIG_AUDIT: 'false'
  NPM_CONFIG_FUND: 'false'
  PROJECT_NAME: 'art-file-watcher'

  REGISTRY_HOST: 'registry.mutua.com.br'
  REGISTRY_USER: 'inova_mutua'

  MINIO_PORT: 9090
  MINIO_ENDPOINT: 'dckr03.mutua.com.br'
  MINIO_REGION: 'us-east-1'
  MINIO_BUCKET: 'mutua360-hmg'
  MINIO_USE_SSL: 'false'

# ===========================================
# STAGE: SETUP
# ===========================================

# Job dedicado para preparar cache de dependÃªncias
prepare_cache:
  stage: setup
  image: node:lts-alpine
  before_script:
    - echo "Preparando cache de dependÃªncias..."
    - node --version
    - npm --version
  script:
    - npm ci --cache .npm --prefer-offline
    - echo "Cache de dependÃªncias preparado com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull-push

# Template para jobs que precisam do MinIO
.minio_setup: &minio_setup
  before_script:
    - echo "Configurando Ambiente de Deploy"
    - docker info
    - echo "Configurando MinIO client (http://$MINIO_ENDPOINT:$MINIO_PORT)"
    - apk add --no-cache curl
    - curl -o /usr/local/bin/mc https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod +x /usr/local/bin/mc
    - mc alias set minio http://$MINIO_ENDPOINT:$MINIO_PORT $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

# ===========================================
# STAGE: LINT (executa lint e test em paralelo)
# ===========================================
lint:
  stage: lint
  image: node:lts-alpine
  dependencies:
    - prepare_cache
  script:
    - echo "Instalando dependÃªncias do cache..."
    - npm ci --cache .npm --prefer-offline
    - echo "ðŸš“ Executando anÃ¡lise de cÃ³digo..."
    - npx eslint src/**/*.ts
    - echo "âœ… Lint executado com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull
  allow_failure: false

test:
  stage: lint
  image: node:lts-alpine
  dependencies:
    - prepare_cache
  script:
    - echo "Instalando dependÃªncias do cache..."
    - npm ci --cache .npm --prefer-offline
    - echo "ðŸ§ª Executando testes unitÃ¡rios..."
    - npm test
    - echo "âœ… Testes executados com sucesso!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull
  allow_failure: false

# ===========================================
# STAGE: BUILD
# ===========================================
build:
  stage: build
  image: node:lts-alpine
  dependencies:
    - prepare_cache
    - lint
    - test
  before_script:
    - echo "Instalando dependÃªncias do cache..."
    - npm ci --cache .npm --prefer-offline
    # - echo "Configurando arquivo de ambiente para build..."
    # - cp .env.homologation .env
  script:
    - echo "ðŸ”¨ Executando build TypeScript..."
    - npm run build
    - echo "ðŸ“¦ Gerando binÃ¡rio Linux..."
    - npm run pkg:linux
    - echo "Verificando arquivos gerados..."
    - ls -la dist/
    - ls -la bin/
    - echo "âœ… Build executado com sucesso!"
  artifacts:
    paths:
      - bin/
      - dist/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
    policy: pull
  allow_failure: false

# ===========================================
# STAGE: DEPLOY
# ===========================================
deploy:staging:
  stage: deploy
  environment:
    name: staging
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build
  variables:
    DOCKER_HOST: 'unix:///runner/services/docker/docker.sock'
    DOCKER_TLS_CERTDIR: '/certs'
    ENVIRONMENT: 'homologation'
    TAG: 'latest'
    WEBHOOK_URL: 'https://portainer-hmg.mutua.com.br/api/webhooks/9b32e5fa-bb5c-4263-94b8-d40be1f5967c'
    IMAGE_NAME: 'registry.mutua.com.br/mutua360/$PROJECT_NAME'

  <<: *minio_setup
  script:
    - export PROJECT_NAME="${PROJECT_NAME}"
    - echo "PROJECT_NAME ${PROJECT_NAME}, TAG ${TAG}, IMAGE_NAME ${IMAGE_NAME} - $IMAGE_NAME:$TAG"
    - echo "ðŸš€ Iniciando deploy para $PROJECT_NAME $ENVIRONMENT - $REGISTRY_USER $REGISTRY_HOST"
    - echo "ðŸ“¦ Verificando binÃ¡rio gerado..."
    - ls -la bin/
    - test -f bin/art-w || (echo "âŒ BinÃ¡rio bin/art-w nÃ£o encontrado!" && exit 1)
    - echo "âœ… BinÃ¡rio encontrado!"
    - docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
    - echo "ðŸ³ Construindo imagem Docker ($IMAGE_NAME:$TAG)"
    - docker build --platform linux/amd64 -t "$IMAGE_NAME:$TAG" .
    - echo "ðŸ“¤ Enviando imagem para o repositÃ³rio..."
    - docker push "$IMAGE_NAME:$TAG"
    - echo "ðŸ”” Disparando webhook de atualizaÃ§Ã£o..."
    - curl -X POST "$WEBHOOK_URL"
    - echo "âœ… Deploy para ${ENVIRONMENT} concluÃ­do com sucesso."
  only:
    - develop
  allow_failure: false

deploy:production:
  stage: deploy
  environment:
    name: production
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build
  variables:
    DOCKER_HOST: 'unix:///runner/services/docker/docker.sock'
    DOCKER_TLS_CERTDIR: '/certs'
    ENVIRONMENT: 'production'
    TAG: 'stable'
    WEBHOOK_URL: 'https://portainer.mutua.com.br/api/webhooks/b78143fd-825f-4995-9a33-e103bbc726c4'
    IMAGE_NAME: 'registry.mutua.com.br/mutua360/$PROJECT_NAME'

  <<: *minio_setup
  script:
    - export PROJECT_NAME="${PROJECT_NAME}"
    - echo "PROJECT_NAME ${PROJECT_NAME}, TAG ${TAG}, IMAGE_NAME ${IMAGE_NAME} - $IMAGE_NAME:$TAG"
    - echo "ðŸš€ Iniciando deploy para $PROJECT_NAME $ENVIRONMENT - $REGISTRY_USER $REGISTRY_HOST"
    - echo "ðŸ“¦ Verificando binÃ¡rio gerado..."
    - ls -la bin/
    - test -f bin/art-w || (echo "âŒ BinÃ¡rio bin/art-w nÃ£o encontrado!" && exit 1)
    - echo "âœ… BinÃ¡rio encontrado!"
    - docker login -u ${REGISTRY_USER} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
    - echo "ðŸ³ Construindo imagem Docker ($IMAGE_NAME:$TAG)"
    - docker build --platform linux/amd64 -t "$IMAGE_NAME:$TAG" .
    - echo "ðŸ“¤ Enviando imagem para o repositÃ³rio..."
    - docker push "$IMAGE_NAME:$TAG"
    - echo "ðŸ”” Disparando webhook de atualizaÃ§Ã£o..."
    - curl -X POST "$WEBHOOK_URL"
    - echo "âœ… Deploy para ${ENVIRONMENT} concluÃ­do com sucesso."

  after_script:
    - echo "âœ… Deploy para ${ENVIRONMENT} concluÃ­do com sucesso."
  only:
    - main
  allow_failure: false
